generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminUser {
  id           String       @id @default(cuid())
  username     String       @unique
  passwordHash String
  role         String       @default("admin")
  avatarUrl    String?
  createdAt    DateTime     @default(now())
  mediaAssets  MediaAsset[]
}

model Sauna {
  id                           String        @id @default(cuid())
  slug                         String        @unique
  name                         String
  location                     String
  shortDescription             String
  description                  String
  imageUrl                     String?
  gallery                      String?
  address                      String?
  mapEmbedUrl                  String?
  latitude                     Float?
  longitude                    Float?
  facilities                   String?
  capacityDropin               Int           @default(0)
  capacityPrivat               Int           @default(0)
  bookingUrlDropin             String?
  bookingUrlPrivat             String?
  status                       String        @default("active")
  sorting                      Int           @default(0)
  driftStatus                  String        @default("open")
  stengeArsak                  String?
  stengtFra                    DateTime?
  stengtTil                    DateTime?
  kundeMelding                 String?
  flexibleHours                Boolean       @default(false)
  hoursMessage                 String?
  seoTitle                     String?
  seoDescription               String?
  updatedAt                    DateTime      @updatedAt
  createdAt                    DateTime      @default(now())
  bookingAvailabilityUrlDropin String?
  bookingAvailabilityUrlPrivat String?
  availabilityData             String?
  previousAvailabilityData     String?
  lastScrapedAt                DateTime?
  hasDropinAvailability        Boolean       @default(true)
  waterTempValue               Float?
  waterTempTime                DateTime?
  waterTempLocationName        String?
  waterTempDistanceKm          Float?
  waterTempFetchedAt           DateTime?
  waterTempSource              String?
  mediaAssets                  MediaAsset[]
  openingHours                 OpeningHour[]
  openingHourOverrides         OpeningHourOverride[]
  priceItems                   PriceItem[]

  // Scraper Health
  // lastScrapeAttemptAt was removed because it is missing in DB
  lastScrapeSuccessAt          DateTime?
  lastScrapeStatus             String?       // "success" | "failed" | "empty"


  @@index([slug])
  @@index([status, sorting])
  @@index([status])
  @@index([driftStatus])
}

model OpeningHourOverride {
  id        String   @id @default(cuid())
  saunaId   String
  date      DateTime
  opens     String?
  closes    String?
  active    Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sauna     Sauna    @relation(fields: [saunaId], references: [id], onDelete: Cascade)

  @@unique([saunaId, date])
  @@index([saunaId])
  @@index([date])
}

model OpeningHour {
  id        String    @id @default(cuid())
  saunaId   String
  type      String    @default("weekly")
  weekday   Int?
  date      DateTime?
  opens     String?
  closes    String?
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  sauna     Sauna     @relation(fields: [saunaId], references: [id], onDelete: Cascade)

  @@index([saunaId])
  @@index([saunaId, type, active])
}

model PriceItem {
  id          String  @id @default(cuid())
  saunaId     String?
  name        String
  category    String?
  price       Float
  currency    String  @default("NOK")
  description String?
  active      Boolean @default(true)
  sorting     Int     @default(0)
  sauna       Sauna?  @relation(fields: [saunaId], references: [id], onDelete: Cascade)

  @@index([saunaId])
  @@index([active, sorting])
}

model SiteSetting {
  key         String  @id
  value       String
  description String?
}

model Subscription {
  id                 String   @id @default(cuid())
  name               String
  price              Float
  currency           String   @default("NOK")
  period             String
  features           String
  description        String?
  sorting            Int      @default(0)
  active             Boolean  @default(true)
  binding            Boolean  @default(false)
  bindingDescription String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  paymentUrl         String?
}

model MediaAsset {
  id                 String     @id @default(cuid())
  saunaId            String?
  kind               String
  storageKeyOriginal String
  storageKeyLarge    String
  storageKeyThumb    String
  mimeType           String
  sizeBytes          Int
  width              Int
  height             Int
  orderIndex         Int        @default(0)
  altText            String?
  status             String     @default("pending")
  creatorId          String?
  createdAt          DateTime   @default(now())
  creator            AdminUser? @relation(fields: [creatorId], references: [id])
  sauna              Sauna?     @relation(fields: [saunaId], references: [id], onDelete: Cascade)

  @@index([saunaId])
  @@index([saunaId, kind, orderIndex])
  @@index([status])
  @@index([creatorId])
}

model AnalyticsSession {
  id          String           @id @default(cuid())
  startTime   DateTime         @default(now())
  endTime     DateTime?
  duration    Int?
  deviceType  String?
  browser     String?
  os          String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  createdAt   DateTime         @default(now())
  events      AnalyticsEvent[]

  @@index([startTime])
}

model AnalyticsEvent {
  id        String           @id @default(cuid())
  sessionId String
  type      String
  eventName String?
  path      String?
  payload   String?
  timestamp DateTime         @default(now())
  session   AnalyticsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([type, timestamp])
  @@index([path])
}

model LighthouseReport {
  id               String   @id @default(cuid())
  url              String
  device           String // 'mobile' or 'desktop'
  performance      Float
  accessibility    Float
  bestPractices    Float
  seo              Float
  pwa              Float?
  firstContentfulPaint  Float?
  largestContentfulPaint Float?
  totalBlockingTime     Float?
  cumulativeLayoutShift Float?
  speedIndex            Float?
  fullReport       String   @db.Text // JSON of full Lighthouse report
  createdAt        DateTime @default(now())
  
  @@index([url, device, createdAt])
  @@index([createdAt])
}

model LighthouseScan {
  id          String   @id @default(cuid())
  status      String   @default("running") // 'running', 'completed', 'failed'
  totalUrls   Int      @default(0)
  completedUrls Int    @default(0)
  failedUrls  Int      @default(0)
  startedAt   DateTime @default(now())
  completedAt DateTime?
  error       String?
  
  @@index([status, startedAt])
}

model AdminLog {
  id          String   @id @default(cuid())
  action      String
  details     String?
  status      String   @default("SUCCESS") // SUCCESS, FAILURE, WARNING
  performedBy String?
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([action])
}

// Privacy & Consent Management Models
model ConsentLog {
  id              String   @id @default(cuid())
  consentVersion  String   @default("v1")
  essential       Boolean  @default(true)
  analysis        Boolean  @default(false)
  functional      Boolean  @default(false)
  marketing       Boolean  @default(false)
  choice          String   // 'accepted', 'declined', 'custom'
  source          String?  // 'banner', 'customize', 'footer'
  // NO personal data before consent - only anonymized identifier if user accepted
  sessionId       String?  
  ipAddressHash   String?  // Only stored if analysis consent given
  timestamp       DateTime @default(now())

  @@index([timestamp])
  @@index([consentVersion])
  @@index([choice])
  @@index([analysis])
}

model PrivacySession {
  id              String   @id // This is the nanoid from frontend
  consentLogId    String?  // Link to consent if given
  firstSeen       DateTime @default(now())
  lastSeen        DateTime @updatedAt
  // Below fields ONLY populated if analysis consent = true
  hasConsent      Boolean  @default(false)
  ipAddress       String?  // Only if hasConsent
  ipAddressHash   String?  // Hashed version
  userAgent       String?  // Only if hasConsent
  deviceType      String?  // desktop/mobile
  browser         String?
  os              String?
  referrer        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  pageviewCount   Int      @default(0)
  eventCount      Int      @default(0)
  createdAt       DateTime @default(now())

  @@index([firstSeen])
  @@index([hasConsent])
  @@index([ipAddressHash])
}

// Scraper Models

model ScrapeRun {
  id              String           @id @default(cuid())
  trigger         String           // "cron" | "on_demand" | "manual"
  status          String           // "running" | "success" | "partial" | "failed" | "cancelled"
  startedAt       DateTime         @default(now())
  finishedAt      DateTime?
  durationMs      Int?
  appVersion      String?          // git sha / build id
  environment     String?          // production/staging
  totalSaunas     Int              @default(0)
  successCount    Int              @default(0)
  failCount       Int              @default(0)
  emptyCount      Int              @default(0)
  notes           String?
  items           ScrapeRunItem[]
  events          ScrapeLogEvent[]
  createdAt       DateTime         @default(now())

  @@index([startedAt])
  @@index([status])
}

model ScrapeRunItem {
  id              String    @id @default(cuid())
  runId           String
  saunaId         String
  status          String    // "success" | "failed" | "empty" | "skipped"
  startedAt       DateTime  @default(now())
  finishedAt      DateTime?
  durationMs      Int?
  targetUrl       String?
  daysScraped     Int       @default(0)
  slotsFound      Int       @default(0)
  reason          String?
  errorCode       String?
  diagnosticsJson String?   @db.Text
  run             ScrapeRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())

  @@index([runId])
  @@index([saunaId])
}

model ScrapeLogEvent {
  id        String    @id @default(cuid())
  runId     String
  level     String    // "debug" | "info" | "warn" | "error"
  scope     String    // "run" | "sauna" | "scraper" | "db" | "ui"
  saunaId   String?
  message   String
  dataJson  String?   @db.Text
  createdAt DateTime  @default(now())
  run       ScrapeRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, createdAt])
}
